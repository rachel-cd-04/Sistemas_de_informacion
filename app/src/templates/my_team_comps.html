<!--Authors: Mateo Peña Costa and Raquel Cámara Domene-->
{% extends "layout.html" %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_TC-style.css') }}">
{% endblock %}

{% block title %}
    My Team Comps
{% endblock %}

{% block main %}
<div class="main-container">
    <h1>MY TEAM COMPS</h1>
    <div class="team-comps-container">
        {% for team_comp in team_comps %}
            <div class="team-comp" onclick="toggleDescription(this)">
                <div class="team-comp-content">
                    <h2>{{ team_comp.nombre }}</h2>
                    <div class="team-comp-difficulty">
                        <span data-difficulty="{{ team_comp.dificultad }}">{{ team_comp.dificultad }}</span>
                    </div>
                    <div class="team-comp-buttons">
                        <button class="publish-btn" data-publicado="{{ team_comp.publicado }}" data-usuario="{{ team_comp.usuario }}" data-nombre="{{ team_comp.nombre }}">Publish</button>
                        <button class="edit-btn">Edit</button>
                        <button class="delete-btn">Delete</button>
                    </div>
                    <div class="team-comp-description">
                        <p>{{ team_comp.descr }}</p>
                    </div>
                </div>
                <div class="team-comp-champions">
                    {% for champion in team_comp.champions %}
                        <div class="team-comp-champion">
                            <img src="{{ champion.url_recom }}" alt="{{ champion.nombre }}">
                            <p>{{ champion.nombre }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}

        <script>
            function toggleDescription(element) {
                element.classList.toggle('expanded');
            }
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const publishButtons = document.querySelectorAll(".publish-btn");
            
                publishButtons.forEach(button => {
                    const isPublished = button.getAttribute("data-publicado") === "Y";
                    button.textContent = isPublished ? "Published" : "Publish";
            
                    button.addEventListener("click", function() {
                        const usuario = button.getAttribute("data-usuario");
                        const nombre = button.getAttribute("data-nombre");
                        const newPublicado = isPublished ? "N" : "Y";
            
                        fetch("/set_publicado", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                usuario: usuario,
                                nombre: nombre,
                                publicado: newPublicado
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                button.setAttribute("data-publicado", newPublicado);
                                button.textContent = newPublicado === "Y" ? "Published" : "Publish";
                                alert("Todo fue correctamente");
                            } else {
                                alert("Error updating publication status");
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("Error updating publication status");
                        });
                    });
                });
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const deleteButtons = document.querySelectorAll(".delete-btn");

                deleteButtons.forEach(button => {
                    button.addEventListener("click", function() {
                        const usuario = button.closest('.team-comp').querySelector('.publish-btn').getAttribute('data-usuario');
                        const nombre = button.closest('.team-comp').querySelector('h2').textContent;

                        if (confirm(`¿Estás seguro de que deseas eliminar la composición "${nombre}"?`)) {
                            fetch("/delete_composition", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    usuario: usuario,
                                    nombre: nombre
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("Composición eliminada exitosamente.");
                                    // Eliminar el elemento del DOM
                                    button.closest('.team-comp').remove();
                                } else {
                                    alert("Error al eliminar la composición.");
                                }
                            })
                            .catch(error => {
                                console.error("Error:", error);
                                alert("Error al eliminar la composición.");
                            });
                        }
                    });
                });
            });
        </script>


{% endblock %}